name: "[PoC Mock] Deploy Apps to UAT"

# PoC MOCK WORKFLOW - For demonstration purposes only
# This simulates selective application deployment to UAT without real Azure resources
#
# IN PRODUCTION: Uncomment the real workflow sections below

on:
  push:
    branches:
      - "releases/**"
    paths:
      - "apps/**"
      - ".github/workflows/_release-deploy-apps-uat.yaml"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'uat'
        type: choice
        options:
          - uat
          - prod

permissions:
  contents: read

jobs:
  # Step 1: Detect which apps changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      onboarding: ${{ steps.filter.outputs.onboarding }}
      product: ${{ steps.filter.outputs.product }}
      iam: ${{ steps.filter.outputs.iam }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Detect changed apps
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        with:
          filters: |
            onboarding:
              - 'apps/onboarding-ms/**'
            product:
              - 'apps/product-ms/**'
            iam:
              - 'apps/iam-ms/**'

      - name: Show detection results
        run: |
          echo "ðŸ” Path Detection Results (UAT):"
          echo "  onboarding-ms: ${{ steps.filter.outputs.onboarding }}"
          echo "  product-ms: ${{ steps.filter.outputs.product }}"
          echo "  iam-ms: ${{ steps.filter.outputs.iam }}"

  # Step 2: Deploy onboarding-ms
  deploy-onboarding:
    needs: detect-changes
    if: needs.detect-changes.outputs.onboarding == 'true'
    name: "[Mock] Deploy Onboarding MS to UAT"
    runs-on: ubuntu-latest
    environment: app-uat-cd
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update App Configuration
        run: |
          echo "âš™ï¸  [MOCK] Updating App Configuration for onboarding-ms in UAT"
          echo ""

          CONFIG_FILE="apps/onboarding-ms/app-config.json"
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ“„ Reading configuration from $CONFIG_FILE"
            cat $CONFIG_FILE | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read LINE; do
              KEY=$(echo $LINE | cut -d'=' -f1)
              VALUE=$(echo $LINE | cut -d'=' -f2-)

              echo "  Setting: onboarding-ms:$KEY = $VALUE"

              # DRY-RUN: In production, uncomment this:
              # az appconfig kv set \
              #   --name selfcare-uat-appconfig \
              #   --key "onboarding-ms:$KEY" \
              #   --value "$VALUE" \
              #   --label "uat" \
              #   --yes
            done
            echo ""
            echo "âœ… [DRY-RUN] Would update $(cat $CONFIG_FILE | jq 'length') configuration values"
          else
            echo "âš ï¸  No app-config.json found"
          fi

      - name: Mock deployment
        run: |
          echo "ðŸš€ [MOCK] Deploying onboarding-ms to UAT"
          echo ""
          echo "In production, this would execute:"
          echo "  - Build Docker image from apps/onboarding-ms"
          echo "  - Push to Azure Container Registry"
          echo "  - Deploy to Container App: selc-u-onboarding-ca"
          echo "  - App reads config from Azure App Configuration"
          echo "  - Health check: /health endpoint"
          echo "  - Wait for approval in 'app-uat-cd' environment"
          echo ""
          echo "âœ… Mock deployment successful"

      # PRODUCTION VERSION (commented for PoC):
      # uses: pagopa/dx/.github/workflows/release-azure-appsvc-v1.yaml@main
      # secrets: inherit
      # with:
      #   environment: app-uat
      #   resource_group_name: selc-u-onboarding-rg
      #   app_name: selc-u-onboarding-ca
      #   package_path: "apps/onboarding-ms"
      #   health_check_path: "/health"
      #   use_private_agent: false

  # Step 3: Deploy product-ms
  deploy-product:
    needs: detect-changes
    if: needs.detect-changes.outputs.product == 'true'
    name: "[Mock] Deploy Product MS to UAT"
    runs-on: ubuntu-latest
    environment: app-uat-cd
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update App Configuration
        run: |
          echo "âš™ï¸  [MOCK] Updating App Configuration for product-ms in UAT"
          echo ""

          CONFIG_FILE="apps/product-ms/app-config.json"
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ“„ Reading configuration from $CONFIG_FILE"
            cat $CONFIG_FILE | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read LINE; do
              KEY=$(echo $LINE | cut -d'=' -f1)
              VALUE=$(echo $LINE | cut -d'=' -f2-)
              echo "  Setting: product-ms:$KEY = $VALUE"
              # DRY-RUN: az appconfig kv set ...
            done
            echo ""
            echo "âœ… [DRY-RUN] Would update $(cat $CONFIG_FILE | jq 'length') configuration values"
          fi

      - name: Mock deployment
        run: |
          echo "ðŸš€ [MOCK] Deploying product-ms to UAT"
          echo ""
          echo "In production, this would execute:"
          echo "  - Build Docker image from apps/product-ms"
          echo "  - Push to Azure Container Registry"
          echo "  - Deploy to Container App: selc-u-product-ca"
          echo "  - Health check: /health endpoint"
          echo "  - Wait for approval in 'app-uat-cd' environment"
          echo ""
          echo "âœ… Mock deployment successful"

      # PRODUCTION VERSION (commented for PoC):
      # uses: pagopa/dx/.github/workflows/release-azure-appsvc-v1.yaml@main
      # secrets: inherit
      # with:
      #   environment: app-uat
      #   resource_group_name: selc-u-product-rg
      #   app_name: selc-u-product-ca
      #   package_path: "apps/product-ms"
      #   health_check_path: "/health"
      #   use_private_agent: false

  # Step 4: Deploy iam-ms
  deploy-iam:
    needs: detect-changes
    if: needs.detect-changes.outputs.iam == 'true'
    name: "[Mock] Deploy IAM MS to UAT"
    runs-on: ubuntu-latest
    environment: app-uat-cd
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update App Configuration
        run: |
          echo "âš™ï¸  [MOCK] Updating App Configuration for iam-ms in UAT"
          echo ""

          CONFIG_FILE="apps/iam-ms/app-config.json"
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ“„ Reading configuration from $CONFIG_FILE"
            cat $CONFIG_FILE | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read LINE; do
              KEY=$(echo $LINE | cut -d'=' -f1)
              VALUE=$(echo $LINE | cut -d'=' -f2-)
              echo "  Setting: iam-ms:$KEY = $VALUE"
              # DRY-RUN: az appconfig kv set ...
            done
            echo ""
            echo "âœ… [DRY-RUN] Would update $(cat $CONFIG_FILE | jq 'length') configuration values"
          fi

      - name: Mock deployment
        run: |
          echo "ðŸš€ [MOCK] Deploying iam-ms to UAT"
          echo ""
          echo "In production, this would execute:"
          echo "  - Build Docker image from apps/iam-ms"
          echo "  - Push to Azure Container Registry"
          echo "  - Deploy to Container App: selc-u-iam-ca"
          echo "  - Health check: /health endpoint"
          echo "  - Wait for approval in 'app-uat-cd' environment"
          echo ""
          echo "âœ… Mock deployment successful"

      # PRODUCTION VERSION (commented for PoC):
      # uses: pagopa/dx/.github/workflows/release-azure-appsvc-v1.yaml@main
      # secrets: inherit
      # with:
      #   environment: app-uat
      #   resource_group_name: selc-u-iam-rg
      #   app_name: selc-u-iam-ca
      #   package_path: "apps/iam-ms"
      #   health_check_path: "/health"
      #   use_private_agent: false

  # Summary
  summary:
    needs: [detect-changes, deploy-onboarding, deploy-product, deploy-iam]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸ“¦ [PoC Mock] Application Deployment Summary - UAT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is a **mock workflow** for demonstration purposes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Microservice | Changed | Would Deploy |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| onboarding-ms | \`${{ needs.detect-changes.outputs.onboarding }}\` | ${{ needs.deploy-onboarding.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| product-ms | \`${{ needs.detect-changes.outputs.product }}\` | ${{ needs.deploy-product.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iam-ms | \`${{ needs.detect-changes.outputs.iam }}\` | ${{ needs.deploy-iam.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Production Setup Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To make this workflow functional in production:" >> $GITHUB_STEP_SUMMARY
          echo "1. Uncomment the DX reusable workflow calls" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure GitHub Environment: \`app-uat-cd\` with approval requirements" >> $GITHUB_STEP_SUMMARY
          echo "3. Set up Azure Federated Identity Credentials" >> $GITHUB_STEP_SUMMARY
          echo "4. Configure secrets: ARM_TENANT_ID, ARM_SUBSCRIPTION_ID, ARM_CLIENT_ID" >> $GITHUB_STEP_SUMMARY
