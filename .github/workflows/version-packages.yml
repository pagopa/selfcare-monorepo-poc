name: Version Packages

on:
  push:
    branches:
      - main
    paths:
      - '.nx/version-plans/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  version:
    name: Create or Update Release PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Upgrade npm
        run: npm install -g npm@11

      - name: Install Dependencies
        run: npm ci

      - name: Check for Version Plans
        id: check
        run: |
          if [ -d ".nx/version-plans" ] && [ "$(ls -A .nx/version-plans/*.md 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "has-plans=true" >> $GITHUB_OUTPUT

            PLAN_COUNT=$(ls -1 .nx/version-plans/*.md 2>/dev/null | wc -l)
            echo "plan-count=$PLAN_COUNT" >> $GITHUB_OUTPUT

            echo "üì¶ Found $PLAN_COUNT version plan(s)"
          else
            echo "has-plans=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No version plans found"
          fi

      - name: Configure Git
        if: steps.check.outputs.has-plans == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Preview Version Changes
        if: steps.check.outputs.has-plans == 'true'
        id: preview
        run: |
          echo "üîç Previewing version changes..."
          npx nx release --dry-run 2>&1 | tee /tmp/release-preview.txt || true

      - name: Detect Prerelease
        if: steps.check.outputs.has-plans == 'true'
        id: detect-prerelease
        run: |
          # Check if any version plan contains prerelease keywords
          if grep -qE "':(prepatch|preminor|premajor|prerelease)" .nx/version-plans/*.md 2>/dev/null; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
            echo "üß™ Detected prerelease version plan"
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            echo "üéØ Detected stable version plan"
          fi

      - name: Apply Version Plans
        if: steps.check.outputs.has-plans == 'true'
        id: release
        run: |
          echo "üì¶ Applying version plans using custom script..."

          # Use custom script that:
          # 1. Applies version changes (pom.xml/package.json)
          # 2. Generates changelogs with correct versions
          # 3. Deletes version plans
          # 4. Regenerates package-lock.json
          # No git commit - let GitHub Actions create PR

          if [ "${{ steps.detect-prerelease.outputs.is-prerelease }}" = "true" ]; then
            echo "üß™ Applying with --preid rc"
            npx nx release --preid rc
          else
            echo "üéØ Applying stable version"
            npx nx release
          fi

          # Update package-lock.json
          npm install --package-lock-only

          # Extract changed projects from modified files
          CHANGED=$(git status --porcelain | grep -E '(pom.xml|package.json)' | grep -E '(apps|infra)' | awk '{print $2}' | xargs -I {} dirname {} | sed 's|^apps/||' | sed 's|^infra/resources/[^/]*/||' | sort -u | tr '\n' ', ' | sed 's/,$//')

          echo "changed-projects=$CHANGED" >> $GITHUB_OUTPUT
          echo "üìã Changed projects: $CHANGED"

          echo "‚úÖ Release script completed - changes ready for PR"

      - name: Create Pull Request Body
        if: steps.check.outputs.has-plans == 'true'
        id: pr-body
        run: |
          cat > /tmp/pr-body.md <<'EOFBODY'
          # ü¶ã Release

          This PR was opened by the **Version Packages** workflow. When you're ready to do a release, merge this PR and packages will be released automatically.

          If you're not ready to release yet, that's fine! Whenever you add more version plans to `main`, this PR will be updated.

          ## üìã Version Plans Applied

          This release applies **${{ steps.check.outputs.plan-count }}** version plan(s).

          <details>
          <summary>üìù View Changed Projects</summary>

          ```
          ${{ steps.release.outputs.changed-projects }}
          ```

          </details>

          ---

          <details>
          <summary>‚ÑπÔ∏è About Version Plans</summary>

          Version plans allow you to declare the type of changes in your code:

          - **patch**: Bug fixes (1.0.0 ‚Üí 1.0.1)
          - **minor**: New features (1.0.0 ‚Üí 1.1.0)
          - **major**: Breaking changes (1.0.0 ‚Üí 2.0.0)
          - **prepatch/preminor/premajor**: RC versions (1.0.0 ‚Üí 1.1.0-rc.0)

          To create a version plan:
          ```bash
          npx nx release plan
          ```

          Multiple version plans are automatically aggregated, with the highest bump type winning.

          </details>
          EOFBODY

      - name: Create or Update Pull Request
        if: steps.check.outputs.has-plans == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: changeset-release/main
          base: main
          title: "chore: Release (Version Packages) ü¶ã"
          body-path: /tmp/pr-body.md
          labels: |
            release
            automated
          commit-message: "chore: version packages"
          delete-branch: false

      - name: No Version Plans Found
        if: steps.check.outputs.has-plans == 'false'
        run: |
          echo "‚ÑπÔ∏è No version plans found in .nx/version-plans/"
          echo "Create one with: npx nx release plan"

      - name: Job Summary
        if: steps.check.outputs.has-plans == 'true'
        run: |
          echo "### ‚úÖ Version Packages PR Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number**: #${{ steps.create-pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Plans Applied**: ${{ steps.check.outputs.plan-count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.summary.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Merge the PR to release! üöÄ" >> $GITHUB_STEP_SUMMARY
