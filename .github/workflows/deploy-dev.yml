name: Deploy DEV

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.nx/version-plans/**'
      - '**/CHANGELOG.md'
      - '.github/**'
      - '**.md'

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.30.0 --activate

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Check Affected Projects
        id: affected
        run: |
          echo "ðŸ” Detecting affected projects with Nx..."

          # Use Nx to detect affected projects
          AFFECTED_LIST=$(pnpm exec nx show projects --affected --base=HEAD~1 --head=HEAD)
          MAVEN_LIST=$(echo "$AFFECTED_LIST" | grep '^it\.pagopa\.selfcare:' || true)
          NON_MAVEN_LIST=$(echo "$AFFECTED_LIST" | grep '^@selfcare:' || true)

          if [ -n "$AFFECTED_LIST" ]; then
            echo "has-affected=true" >> $GITHUB_OUTPUT
            if [ -n "$MAVEN_LIST" ]; then
              echo "has-maven=true" >> $GITHUB_OUTPUT
            else
              echo "has-maven=false" >> $GITHUB_OUTPUT
            fi
            if [ -n "$NON_MAVEN_LIST" ]; then
              echo "has-non-maven=true" >> $GITHUB_OUTPUT
            else
              echo "has-non-maven=false" >> $GITHUB_OUTPUT
            fi
            # Convert newline-separated list to space-separated for output
            PROJECTS=$(echo "$AFFECTED_LIST" | tr '\n' ' ' | xargs)
            MAVEN_PROJECTS=$(echo "$MAVEN_LIST" | tr '\n' ' ' | xargs)
            NON_MAVEN_PROJECTS=$(echo "$NON_MAVEN_LIST" | tr '\n' ' ' | xargs)
            echo "projects=$PROJECTS" >> $GITHUB_OUTPUT
            echo "maven-projects=$MAVEN_PROJECTS" >> $GITHUB_OUTPUT
            echo "non-maven-projects=$NON_MAVEN_PROJECTS" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Affected projects:"
            echo "$AFFECTED_LIST" | sed 's/^/  - /'
          else
            echo "has-affected=false" >> $GITHUB_OUTPUT
            echo "has-maven=false" >> $GITHUB_OUTPUT
            echo "has-non-maven=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No affected projects"
          fi

      - name: Deploy Affected to DEV
        if: steps.affected.outputs.has-non-maven == 'true'
        run: |
          echo "ðŸš€ Deploying affected projects to DEV..."
          echo ""

          # Use Nx to run deploy target on affected projects
          pnpm exec nx run-many --target=deploy --configuration=dev --projects=${{ steps.affected.outputs.non-maven-projects }}

          echo ""
          echo "âœ… Deployment to DEV completed"

      - name: Mock Deploy Maven Projects
        if: steps.affected.outputs.has-maven == 'true'
        run: |
          echo "ðŸ§ª Mock deploy for Maven projects (PoC)"
          for project in ${{ steps.affected.outputs.maven-projects }}; do
            echo "  - $project (mock deploy)"
          done

      - name: No Affected Projects
        if: steps.affected.outputs.has-affected == 'false'
        run: |
          echo "â„¹ï¸ No affected projects to deploy"

      - name: Job Summary
        if: steps.affected.outputs.has-affected == 'true'
        run: |
          echo "### ðŸš€ DEV Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Projects (non-Maven)**:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for project in ${{ steps.affected.outputs.non-maven-projects }}; do
            echo "- $project" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mock Deployed Projects (Maven)**:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for project in ${{ steps.affected.outputs.maven-projects }}; do
            echo "- $project" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
