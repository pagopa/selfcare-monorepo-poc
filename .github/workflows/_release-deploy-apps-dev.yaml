name: "[PoC Mock] Deploy Apps to DEV"

# PoC MOCK WORKFLOW - For demonstration purposes only
# This simulates selective application deployment without real Azure resources
#
# IN PRODUCTION: Uncomment the real workflow sections below

on:
  push:
    branches:
      - main
    paths:
      - "apps/**"
      - ".github/workflows/_release-deploy-apps-dev.yaml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Step 1: Detect which apps changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      onboarding: ${{ steps.filter.outputs.onboarding }}
      product: ${{ steps.filter.outputs.product }}
      iam: ${{ steps.filter.outputs.iam }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Detect changed apps
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        with:
          filters: |
            onboarding:
              - 'apps/onboarding-ms/**'
            product:
              - 'apps/product-ms/**'
            iam:
              - 'apps/iam-ms/**'

      - name: Show detection results
        run: |
          echo "ðŸ” Path Detection Results:"
          echo "  onboarding-ms: ${{ steps.filter.outputs.onboarding }}"
          echo "  product-ms: ${{ steps.filter.outputs.product }}"
          echo "  iam-ms: ${{ steps.filter.outputs.iam }}"

  # Step 2: Deploy onboarding-ms
  deploy-onboarding:
    needs: detect-changes
    if: needs.detect-changes.outputs.onboarding == 'true'
    name: "[Mock] Deploy Onboarding MS"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update App Configuration
        run: |
          echo "âš™ï¸  [MOCK] Updating App Configuration for onboarding-ms in DEV"
          echo ""

          # Read app-config.json
          CONFIG_FILE="apps/onboarding-ms/app-config.json"
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ“„ Reading configuration from $CONFIG_FILE"
            cat $CONFIG_FILE | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read LINE; do
              KEY=$(echo $LINE | cut -d'=' -f1)
              VALUE=$(echo $LINE | cut -d'=' -f2-)

              echo "  Setting: onboarding-ms:$KEY = $VALUE"

              # DRY-RUN: In production, uncomment this:
              # az appconfig kv set \
              #   --name selfcare-dev-appconfig \
              #   --key "onboarding-ms:$KEY" \
              #   --value "$VALUE" \
              #   --label "dev" \
              #   --yes
            done
            echo ""
            echo "âœ… [DRY-RUN] Would update $(cat $CONFIG_FILE | jq 'length') configuration values"
          else
            echo "âš ï¸  No app-config.json found, skipping configuration update"
          fi

      - name: Mock deployment
        run: |
          echo "ðŸš€ [MOCK] Deploying onboarding-ms to DEV"
          echo ""
          echo "In production, this would execute:"
          echo "  - Build Docker image from apps/onboarding-ms"
          echo "  - Push to Azure Container Registry"
          echo "  - Deploy to Container App: selc-d-onboarding-ca"
          echo "  - App reads config from Azure App Configuration"
          echo "  - Health check: /health endpoint"
          echo ""
          echo "âœ… Mock deployment successful"

      # PRODUCTION VERSION (commented for PoC):
      # uses: pagopa/dx/.github/workflows/release-azure-appsvc-v1.yaml@main
      # secrets: inherit
      # with:
      #   environment: app-dev
      #   resource_group_name: selc-d-onboarding-rg
      #   app_name: selc-d-onboarding-ca
      #   package_path: "apps/onboarding-ms"
      #   health_check_path: "/health"
      #   use_private_agent: false

  # Step 3: Deploy product-ms
  deploy-product:
    needs: detect-changes
    if: needs.detect-changes.outputs.product == 'true'
    name: "[Mock] Deploy Product MS"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update App Configuration
        run: |
          echo "âš™ï¸  [MOCK] Updating App Configuration for product-ms in DEV"
          echo ""

          CONFIG_FILE="apps/product-ms/app-config.json"
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ“„ Reading configuration from $CONFIG_FILE"
            cat $CONFIG_FILE | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read LINE; do
              KEY=$(echo $LINE | cut -d'=' -f1)
              VALUE=$(echo $LINE | cut -d'=' -f2-)

              echo "  Setting: product-ms:$KEY = $VALUE"

              # DRY-RUN: In production, uncomment this:
              # az appconfig kv set \
              #   --name selfcare-dev-appconfig \
              #   --key "product-ms:$KEY" \
              #   --value "$VALUE" \
              #   --label "dev" \
              #   --yes
            done
            echo ""
            echo "âœ… [DRY-RUN] Would update $(cat $CONFIG_FILE | jq 'length') configuration values"
          else
            echo "âš ï¸  No app-config.json found"
          fi

      - name: Mock deployment
        run: |
          echo "ðŸš€ [MOCK] Deploying product-ms to DEV"
          echo ""
          echo "In production, this would execute:"
          echo "  - Build Docker image from apps/product-ms"
          echo "  - Push to Azure Container Registry"
          echo "  - Deploy to Container App: selc-d-product-ca"
          echo "  - Health check: /health endpoint"
          echo ""
          echo "âœ… Mock deployment successful"

      # PRODUCTION VERSION (commented for PoC):
      # uses: pagopa/dx/.github/workflows/release-azure-appsvc-v1.yaml@main
      # secrets: inherit
      # with:
      #   environment: app-dev
      #   resource_group_name: selc-d-product-rg
      #   app_name: selc-d-product-ca
      #   package_path: "apps/product-ms"
      #   health_check_path: "/health"
      #   use_private_agent: false

  # Step 4: Deploy iam-ms
  deploy-iam:
    needs: detect-changes
    if: needs.detect-changes.outputs.iam == 'true'
    name: "[Mock] Deploy IAM MS"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update App Configuration
        run: |
          echo "âš™ï¸  [MOCK] Updating App Configuration for iam-ms in DEV"
          echo ""

          CONFIG_FILE="apps/iam-ms/app-config.json"
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ“„ Reading configuration from $CONFIG_FILE"
            cat $CONFIG_FILE | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read LINE; do
              KEY=$(echo $LINE | cut -d'=' -f1)
              VALUE=$(echo $LINE | cut -d'=' -f2-)

              echo "  Setting: iam-ms:$KEY = $VALUE"

              # DRY-RUN: In production, uncomment this:
              # az appconfig kv set \
              #   --name selfcare-dev-appconfig \
              #   --key "iam-ms:$KEY" \
              #   --value "$VALUE" \
              #   --label "dev" \
              #   --yes
            done
            echo ""
            echo "âœ… [DRY-RUN] Would update $(cat $CONFIG_FILE | jq 'length') configuration values"
          else
            echo "âš ï¸  No app-config.json found"
          fi

      - name: Mock deployment
        run: |
          echo "ðŸš€ [MOCK] Deploying iam-ms to DEV"
          echo ""
          echo "In production, this would execute:"
          echo "  - Build Docker image from apps/iam-ms"
          echo "  - Push to Azure Container Registry"
          echo "  - Deploy to Container App: selc-d-iam-ca"
          echo "  - Health check: /health endpoint"
          echo ""
          echo "âœ… Mock deployment successful"

      # PRODUCTION VERSION (commented for PoC):
      # uses: pagopa/dx/.github/workflows/release-azure-appsvc-v1.yaml@main
      # secrets: inherit
      # with:
      #   environment: app-dev
      #   resource_group_name: selc-d-iam-rg
      #   app_name: selc-d-iam-ca
      #   package_path: "apps/iam-ms"
      #   health_check_path: "/health"
      #   use_private_agent: false

  # Summary
  summary:
    needs: [detect-changes, deploy-onboarding, deploy-product, deploy-iam]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸ“¦ [PoC Mock] Application Deployment Summary - DEV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is a **mock workflow** for demonstration purposes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Microservice | Changed | Would Deploy |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| onboarding-ms | \`${{ needs.detect-changes.outputs.onboarding }}\` | ${{ needs.deploy-onboarding.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| product-ms | \`${{ needs.detect-changes.outputs.product }}\` | ${{ needs.deploy-product.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iam-ms | \`${{ needs.detect-changes.outputs.iam }}\` | ${{ needs.deploy-iam.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Production Setup Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To make this workflow functional in production:" >> $GITHUB_STEP_SUMMARY
          echo "1. Uncomment the DX reusable workflow calls" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure GitHub Environment: \`app-dev-cd\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Set up Azure Federated Identity Credentials" >> $GITHUB_STEP_SUMMARY
          echo "4. Configure secrets: ARM_TENANT_ID, ARM_SUBSCRIPTION_ID, ARM_CLIENT_ID" >> $GITHUB_STEP_SUMMARY
