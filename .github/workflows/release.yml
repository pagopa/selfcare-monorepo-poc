name: Release

on:
  push:
    branches:
      - main
    paths:
      - '**/pom.xml'
      - '**/package.json'
      - '**/CHANGELOG.md'

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Create Tags and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Upgrade npm
        run: npm install -g npm@11

      - name: Install Dependencies
        run: npm ci

      - name: Create Git Tags
        id: tags
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          TAGS_CREATED=""

          # Process Maven projects (apps with pom.xml)
          for file in $(git diff HEAD~1 --name-only | grep 'pom.xml' | grep -E '(apps)'); do
            PROJECT=$(echo $file | sed 's|apps/||' | sed 's|/pom.xml||')
            # Extract version from pom.xml
            VERSION=$(grep -A 1 "<artifactId>$PROJECT</artifactId>" "$file" | grep "<version>" | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | head -1)

            if [ -n "$VERSION" ]; then
              TAG_NAME="$PROJECT-v$VERSION"
              echo "ðŸ“¦ Creating tag: $TAG_NAME (from pom.xml)"

              git tag "$TAG_NAME" -m "Release $PROJECT v$VERSION"
              TAGS_CREATED="$TAGS_CREATED $TAG_NAME"
            fi
          done

          # Process infra projects (package.json)
          for file in $(git diff HEAD~1 --name-only | grep 'package.json' | grep -E '(infra)'); do
            VERSION=$(jq -r '.version' $file 2>/dev/null)
            PROJECT=$(echo $file | sed 's|/package.json||' | sed 's|infra/.*/||')

            if [ "$VERSION" != "null" ] && [ -n "$VERSION" ]; then
              TAG_NAME="$PROJECT-v$VERSION"
              echo "ðŸ“¦ Creating tag: $TAG_NAME (from package.json)"

              git tag "$TAG_NAME" -m "Release $PROJECT v$VERSION"
              TAGS_CREATED="$TAGS_CREATED $TAG_NAME"
            fi
          done

          git push origin --tags

          echo "tags-created<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS_CREATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Determine Deployment Environment
        id: env
        run: |
          # Auto-detect RC/prerelease vs stable from pom.xml and package.json versions
          # Matches: -rc.0, -0, -alpha.1, -beta.2, etc.
          if git diff HEAD~1 --name-only | xargs grep -E '(<version>.*-[a-z0-9]+</version>|"version".*-[a-z0-9]+)' 2>/dev/null; then
            echo "target=uat" >> $GITHUB_OUTPUT
            echo "ðŸ§ª Detected prerelease versions â†’ deploying to UAT"
          else
            echo "target=prod" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Detected stable versions â†’ deploying to PROD"
          fi

      - name: Deploy Affected Projects (Mock)
        run: |
          echo "ðŸš€ Deploying to ${{ steps.env.outputs.target }}"

          # In real scenario: npx nx affected --target=deploy --configuration=${{ steps.env.outputs.target }} --base=HEAD~1
          # For PoC: just show what would be deployed

          echo "ðŸ“‹ Affected projects:"

          # Maven projects (apps)
          for file in $(git diff HEAD~1 --name-only | grep 'pom.xml' | grep -E '(apps)'); do
            PROJECT=$(echo $file | sed 's|apps/||' | sed 's|/pom.xml||')
            VERSION=$(grep -A 1 "<artifactId>$PROJECT</artifactId>" "$file" | grep "<version>" | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | head -1)
            echo "  - $PROJECT (v$VERSION) [Maven]"
          done

          # Infra projects (package.json)
          for file in $(git diff HEAD~1 --name-only | grep 'package.json' | grep -E '(infra)'); do
            PROJECT=$(echo $file | sed 's|/package.json||')
            VERSION=$(jq -r '.version' $file)
            echo "  - $PROJECT (v$VERSION) [Node]"
          done

          echo ""
          echo "âœ… Mock deployment to ${{ steps.env.outputs.target }} completed"

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Read CHANGELOG for release notes
            let changelogContent = 'See individual project CHANGELOGs for details.';
            try {
              if (fs.existsSync('CHANGELOG.md')) {
                const content = fs.readFileSync('CHANGELOG.md', 'utf8');
                const sections = content.split(/^## /m);
                if (sections.length > 1) {
                  changelogContent = '## ' + sections[1];
                }
              }
            } catch (e) {
              console.log('No CHANGELOG.md found');
            }

            // Get latest tag
            let tagName;
            try {
              tagName = execSync('git describe --tags --abbrev=0').toString().trim();
            } catch (e) {
              console.log('No tags found yet');
              return;
            }

            // Determine if prerelease by checking tag name for any prerelease suffix
            // Matches: -0, -1, -rc.0, -alpha.1, -beta.2, etc.
            const isPrerelease = /-[a-z0-9]+(\.[0-9]+)?$/i.test(tagName);

            // Create release
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `${isPrerelease ? 'ðŸ§ª RC' : 'ðŸŽ¯ Release'} ${tagName}`,
              body: changelogContent,
              prerelease: isPrerelease
            });

            console.log(`âœ… Created GitHub Release: ${tagName}`);

      - name: Job Summary
        run: |
          echo "### âœ… Release Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ steps.env.outputs.target }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags Created**: ${{ steps.tags.outputs.tags-created }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed**: $(date)" >> $GITHUB_STEP_SUMMARY
